<%- include('partials/header', { titulo: 'Registrar pago' }) %>

<h2 class="mb-3">Registrar pago</h2>

<form action="/pagos/nuevo" method="POST" class="mb-4" id="form-pago">
  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">Venta</label>
      <select name="VentaID" id="venta" class="form-select" required>
        <option value="">Seleccione…</option>
        <% ventas.forEach(v => { %>
          <option 
            value="<%= v.VentaID %>" 
            data-total="<%= Number(v.MontoTotal) %>"
            data-cliente="<%= v.Cliente %>"
          >
            <%= v.VentaID %> — <%= v.Cliente %> — Total: ₡<%= Number(v.MontoTotal).toFixed(2) %>
          </option>
        <% }) %>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Cliente</label>
      <input type="text" id="cliente" class="form-control" readonly>
    </div>

    <div class="col-md-3">
      <label class="form-label">Total de la venta</label>
      <input type="text" id="totalVenta" class="form-control" value="₡0.00" readonly>
    </div>

    <div class="col-md-3">
      <label class="form-label">Fecha de pago</label>
      <input type="date" name="FechaPago" class="form-control" value="<%= new Date().toISOString().split('T')[0] %>">
    </div>

    <div class="col-md-3">
      <label class="form-label">Método</label>
      <select name="MetodoPago" class="form-select" required>
        <option>Efectivo</option>
        <option>Tarjeta</option>
        <option>SINPE</option>
        <option>Transferencia</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Monto</label>
      <input type="number" step="0.01" min="0" name="Monto" id="monto" class="form-control" required>
    </div>

    <div class="col-md-3">
      <label class="form-label">Saldo estimado</label>
      <input type="text" id="saldo" class="form-control" value="₡0.00" readonly>
    </div>
  </div>

  <div class="mt-3">
    <button class="btn btn-success">Guardar pago</button>
    <a href="/pagos" class="btn btn-secondary">Cancelar</a>
  </div>
</form>

<script>
  const selVenta = document.getElementById('venta');
  const totalEl  = document.getElementById('totalVenta');
  const clienteEl = document.getElementById('cliente');
  const montoEl  = document.getElementById('monto');
  const saldoEl  = document.getElementById('saldo');

  function fmt(n){ return '₡' + Number(n||0).toFixed(2); }

  function recalcular(){
    const opt = selVenta.selectedOptions[0];
    const total = Number(opt?.dataset?.total || 0);
    totalEl.value = fmt(total);
    clienteEl.value = opt?.dataset?.cliente || '';
    const pag = Number(montoEl.value || 0);
    saldoEl.value = fmt(total - pag);
  }

  selVenta.addEventListener('change', recalcular);
  montoEl.addEventListener('input', recalcular);
</script>

<%- include('partials/footer') %>
